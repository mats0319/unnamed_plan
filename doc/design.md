# 设计草稿

## 调用链追踪

学习微服务-调用链追踪——收集日志，统一分析；每一条日志都需要记录请求ID、服务ID、当前实例ID、来源实例ID，
然后不同文件中根据请求ID和来源实例ID还原调用链路。这样一来，对于当前项目，需要改造的地方有：

1. 网关层，收到请求、即将返回请求处理结果时
2. 业务服务，接收到网关转发的请求时打印日志，然后不出错就不打印了，出错的打印也要添加请求ID
3. 网关层向业务服务转发请求时，要带上请求ID
4. 业务服务启动的时候，要为自己生成一个实例ID，服务ID可以就用定义好的常量，在分析的时候，也能知道这一步是哪个服务做的
5. 日志打印样式调整，增加关键参数适配
6. 日志收集，（单独写一个服务）收集所有服务的日志，每个服务增加一个rpc方法，新的调用链追踪服务调用这个方法时，返回当前实例的日志

实现步骤：

1. 日志收集
    1. admin为S级管理员新增页面：查看日志
    2. 编写新的日志收集功能，编写新的服务（以下称为**调用链追踪**服务），与核心服务平级
    3. 前端向网关发起请求，网关转发请求到调用链追踪服务
2. 编写日志分析功能
    1. 日志打印样式调整，增加关键参数适配
    2. 日志提取和分析
3. 展示日志分析结果

## 循环依赖问题(draft)

服务间传递消息：

1. 每个需要调用其他服务的服务，内置一个服务注册中心-嵌入模块（rce），由该模块发起调用
2. 服务启动时，rce模块向rcc（服务注册中心-核心模块）注册自己
3. 调用另一个服务时，如果没有对应服务的target，则向rcc申请获取

当前实现：

1. 我们按照模块划分服务，所以可能同时存在服务A调用服务B、服务B又要调用服务A的情况，这将构成循环依赖；考虑引入消息队列进行解耦
    1. 虽然现在没有循环依赖的例子，不过这是可能存在的，假设哪天我要做一个新功能：  
       **一个用户登录`public_web`时，如果他没有上传过文件，则对其屏蔽云文件模块**  
       假设我们通过向云文件服务查询来确定该用户是否上传过文件，这时用户服务将依赖云文件服务；之前有云文件服务依赖于用户服务，形成循环依赖
    2. 使用消息队列，原本的**循环依赖**将变成**所有服务都依赖于消息队列**，以此实现解耦
2. 当前代码中，rcc模块与rce模块之间相互依赖。  
   这和消息队列一样，都是属于基础设施，而且这两个模块并不具有循环依赖的弊端，所以这两个模块并不构成循环依赖

问题：

1. 循环依赖是一个不好的现象，简单来说，它会将微服务架构变成**分布式单体架构**，  
   想象一下，两个服务构成循环依赖，修改其中一个，另一个也要测试，维护起来很麻烦；  
   再想象一下，构成循环依赖的服务在部署的时候要一起部署，只部署一个，项目没法跑起来

如何避免服务之间出现循环依赖：

1. 明确定义服务之间的层级关系，**高级服务**可以依赖**基础服务**，反之，不行
    1. 例如问题1中的例子，将用户服务定义为基础服务，我们可以在用户表中增加字段，记录该用户是否上传过文件，
       由云文件服务触发该字段的更新，此时用户服务就不用依赖云文件服务了
2. 重新划分服务/定义服务边界，将2个服务的依赖环展开成3个服务的依赖链（或者将其合并）
    1. 举个例子，假设服务A、B构成循环依赖，我们将服务B拆分成B1、B2，  
       其中B1包含依赖服务A的部分，而原本服务A依赖的服务B的部分则转移到服务B2，  
       即此时的依赖关系，由`A->B,B->A`转换成`B1->A->B2`，循环被打破了
3. 异步调用
    1. 一种实现方式是将一个功能拆分成两个函数，以云文件服务-修改文件功能为例：  
       首先做参数检查，然后调用用户服务验证用户名和密码；  
       云文件服务响应用户服务验证成功事件，继续执行修改文件功能
    2. 举个例子，当我们使用消息队列的时候，服务间的循环依赖就变成了所有服务都依赖于消息队列

我个人更倾向于前两种方式：使用更好的设计来解决问题

思考：

1. 引入消息队列是为了解决循环依赖，可服务向消息队列写消息是**服务依赖于消息队列**，  
   而消息队列向服务推送消息是**消息队列依赖于服务**，那么这是不是一种新的循环依赖呢？
   不是，我们要避免的，是微服务架构内的**业务服务**之间出现循环依赖，而消息队列更像是基础设施；  
   换一个例子，mysql支持订阅数据库的变化，那么是不是mysql和业务服务之间也是循环依赖呢？显然不是

## 性能监控

pprof

## 熔断、限流、降级

熔断、降级拟合并到服务注册中心，限流拟合并到API网关
